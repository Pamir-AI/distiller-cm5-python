#!/bin/bash

# Pre-commit hook for code quality checks
echo "Running pre-commit checks..."

# Check for unstaged changes in staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(py|qml|js|json|sh)$')

if [ -z "$STAGED_FILES" ]; then
    echo "No relevant files staged for commit. Skipping checks."
    exit 0
fi

# Run checks only on Python files
PYTHON_FILES=$(echo "$STAGED_FILES" | grep -E '\.py$')
if [ -n "$PYTHON_FILES" ]; then
    echo "Checking Python files for issues..."
    
    # Check if flake8 is installed
    if command -v flake8 >/dev/null 2>&1; then
        echo "Running flake8..."
        echo "$PYTHON_FILES" | xargs flake8 --config=.flake8 2>/dev/null || {
            echo "❌ Flake8 found issues in your Python code. Please fix them before committing."
            echo "Run 'flake8 path/to/file.py' to see detailed errors."
            exit 1
        }
    else
        echo "⚠️ flake8 not found. Skipping Python linting."
    fi
    
    # Check for Python syntax errors
    for file in $PYTHON_FILES; do
        python -m py_compile "$file" 2>/dev/null || {
            echo "❌ Syntax error in $file. Please fix before committing."
            exit 1
        }
    done
fi

# Check QML files
QML_FILES=$(echo "$STAGED_FILES" | grep -E '\.qml$')
if [ -n "$QML_FILES" ]; then
    echo "Checking QML files..."
    
    # Basic QML validation (if qmlls or similar tool is available)
    # This is a basic check since full QML validation often requires the Qt environment
    for file in $QML_FILES; do
        grep -q "import QtQuick" "$file" || {
            echo "⚠️ Warning: $file might be missing QtQuick import."
        }
    done
fi

echo "✅ Pre-commit checks passed!"
exit 0 